<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Courses Metro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 12px;
      background: #0f172a;
      color: #f9fafb;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 0.25rem;
    }

    p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.7);
      margin: 10px 0;
      border: 1px solid #1e293b;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #f9fafb;
      font-size: 0.9rem;
    }

    input[type="text"]::placeholder {
      color: #64748b;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: #1e293b;
      color: #e5e7eb;
    }

    .btn-danger {
      background: #b91c1c;
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #475569;
      color: #e5e7eb;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .col {
      flex: 1 1 100%;
    }

    .col-2 {
      flex: 1 1 calc(50% - 4px);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .products-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #1e293b;
    }

    .product-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #111827;
      font-size: 0.85rem;
    }

    .product-row:last-child {
      border-bottom: none;
    }

    .product-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .product-name {
      font-weight: 500;
    }

    .product-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    /* SWIPE OVERLAY */
    .swipe-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1d283a, #020617 60%);
      display: none;
      z-index: 50;
      padding: 12px;
    }

    .swipe-inner {
      max-width: 480px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .swipe-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #cbd5f5;
      font-size: 0.85rem;
    }

    .swipe-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 16px;
      border-radius: 18px;
      background: linear-gradient(145deg, #020617, #111827);
      border: 1px solid #1d4ed8;
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      touch-action: pan-y;
    }

    .swipe-top {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
    }

    .swipe-rayon {
      font-size: 1.1rem;
      color: #93c5fd;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .swipe-stock {
      font-size: 0.8rem;
      color: #cbd5f5;
    }

    .swipe-name {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .qty-control {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 0;
      border-radius: 999px;
      border: 1px solid #1e40af;
      overflow: hidden;
      background: #020617;
    }

    .qty-btn {
      width: 42px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 1.1rem;
    }

    .qty-value {
      min-width: 50px;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
    }

    .swipe-hints {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 6px;
      text-align: center;
    }

    .swipe-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn-swipe-add {
      flex: 1;
      background: #16a34a;
      color: white;
      font-size: 1rem;
      padding-block: 10px;
    }

    .btn-swipe-skip {
      flex: 1;
      background: #1e293b;
      color: #e5e7eb;
      font-size: 1rem;
      padding-block: 10px;
    }

    .swipe-progress {
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      margin-top: 4px;
    }

    /* RESULT LIST */
    .result-list {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #1e293b;
    }

    .rayon-title {
      padding: 6px 10px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #93c5fd;
      border-bottom: 1px solid #0f172a;
      background: #020617;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 10px;
      border-bottom: 1px solid #020617;
      font-size: 0.9rem;
    }

    .result-row:last-child {
      border-bottom: none;
    }

    .result-name {
      font-weight: 500;
    }

    .result-qty {
      font-weight: 600;
      color: #e5e7eb;
    }

    .print-only-title {
      display: none;
    }

    #printListContainer {
      display: none;
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .card {
        padding: 12px;
      }
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 16px;
      }
      .no-print {
        display: none !important;
      }
      .print-only-title {
        display: block !important;
        font-size: 1.3rem;
        margin-bottom: 8px;
      }
      #printListContainer {
        display: block;
      }
      .result-list {
        border-color: #000;
      }
      .rayon-title {
        background: #f3f4f6;
        color: #111827;
        border-color: #000;
      }
      .result-row {
        border-color: #e5e7eb;
      }
    }
  </style>
</head>
<body>
  <div class="app no-print">
    <!-- PAGE ACCUEIL : COURSES METRO -->
    <div id="pageHome">
      <h1>üõí Courses Metro</h1>
      <p>Cr√©e ta liste en swipant tes produits dans l‚Äôordre des rayons Metro.</p>

      <!-- Cr√©ation de liste par swipe -->
      <div class="card">
        <h2 style="font-size:1.1rem;margin:0 0 8px;">Cr√©er une liste (mode swipe)</h2>
        <p>
          Les produits seront propos√©s <strong>dans l‚Äôordre des zones de stockage</strong> :
          chambre froide ‚Üí piece a viande ‚Üí produits d'entretien ‚Üí caveau ‚Üí garage.<br/>
          √Ä l‚Äôint√©rieur de chaque zone : tri par rayon Metro, puis par nom.<br/>
          Swipe <strong>gauche = ajouter</strong>, swipe <strong>droite = passer</strong>.
        </p>

        <div class="header-actions">
          <button id="startSession" class="btn-primary btn-full">
            üöÄ D√©marrer la liste (mode swipe)
          </button>
        </div>

        <div id="sessionSummary" style="margin-top:10px;display:none;">
          <p style="font-size:0.85rem;color:#9ca3af;margin-bottom:6px;">
            Derni√®re liste cr√©√©e :
          </p>
          <div id="resultList" class="result-list"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button id="printList" class="btn-secondary btn-full">üñ® Imprimer / PDF</button>
          </div>
        </div>
      </div>

      <button id="goProducts" class="btn-secondary btn-full" style="margin-top:8px;">
        üì¶ G√©rer mes produits
      </button>
    </div>

    <!-- PAGE PRODUITS -->
    <div id="pageProducts" style="display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <button id="backHome" class="btn-outline btn-small">‚Üê Retour</button>
        <span style="font-size:1.1rem;font-weight:600;">Mes produits</span>
      </div>

      <div class="card">
        <form id="productForm">
          <div class="row">
            <div class="col">
              <label for="prodName">Produit</label>
              <input id="prodName" type="text" placeholder="Ex : salade, steak hach√©..." required />
            </div>
          </div>
          <div class="row" style="margin-top:6px;">
            <div class="col-2">
              <label for="prodRayon">Rayon magasin</label>
              <select id="prodRayon">
                <option value="fruits et legumes">fruits et legumes</option>
                <option value="frais">frais</option>
                <option value="surgeles">surgeles</option>
                <option value="sec">sec</option>
                <option value="alcool">alcool</option>
                <option value="softs">softs</option>
                <option value="hygiene">hygiene</option>
                <option value="materiel">materiel</option>
              </select>
            </div>
            <div class="col-2">
              <label for="prodQty">Qt√© par d√©faut</label>
              <input id="prodQty" type="number" min="1" value="1" />
            </div>
          </div>
          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label for="prodStock">Stockage au restaurant</label>
              <select id="prodStock">
                <option value="chambre froide">chambre froide</option>
                <option value="piece a viande">piece a viande</option>
                <option value="produits d'entretien">produits d'entretien</option>
                <option value="caveau">caveau</option>
                <option value="garage">garage</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button type="submit" class="btn-primary btn-full">
              + Ajouter / mettre √† jour
            </button>
          </div>
        </form>

        <div style="margin-top:10px;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <span style="font-size:0.85rem;color:#9ca3af;">Produits enregistr√©s</span>
            <button id="resetProducts" class="btn-outline btn-small">Tout effacer</button>
          </div>
          <div id="productsList" class="products-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu imprim√© -->
  <div class="print-only-title">Courses Metro - Liste</div>
  <div id="printListContainer" class="result-list"></div>

  <!-- Swipe overlay -->
  <div id="swipeOverlay" class="swipe-overlay">
    <div class="swipe-inner">
      <div class="swipe-header">
        <span>Choisir les articles</span>
        <button id="closeSwipe" class="btn-outline btn-small">Terminer</button>
      </div>

      <div id="swipeCard" class="swipe-card">
        <div class="swipe-top">
          <div id="swipeRayon" class="swipe-rayon"></div>
          <div id="swipeStock" class="swipe-stock"></div>
          <div id="swipeName" class="swipe-name"></div>

          <div class="qty-control">
            <button id="btnQtyMinus" class="qty-btn">‚àí</button>
            <div id="qtyValue" class="qty-value">1</div>
            <button id="btnQtyPlus" class="qty-btn">+</button>
          </div>

          <div class="swipe-hints">
            Swipe gauche = <strong>ajouter</strong> ¬∑ Swipe droite = <strong>passer</strong><br/>
            Ou utilise les boutons en bas.
          </div>
        </div>

        <div class="swipe-actions">
          <button id="btnAdd" class="btn-swipe-add">‚¨Ö Ajouter</button>
          <button id="btnSkip" class="btn-swipe-skip">Passer ‚û°</button>
        </div>
        <div id="swipeProgress" class="swipe-progress"></div>
      </div>
    </div>
  </div>

<script>
/* NAVIGATION ENTRE HOME / PRODUITS */
const pageHome = document.getElementById("pageHome");
const pageProducts = document.getElementById("pageProducts");
const goProducts = document.getElementById("goProducts");
const backHome = document.getElementById("backHome");

goProducts.onclick = () => {
  pageHome.style.display = "none";
  pageProducts.style.display = "block";
};

backHome.onclick = () => {
  pageProducts.style.display = "none";
  pageHome.style.display = "block";
};

/* STORAGE */
const STORAGE_KEY = "smartShoppingProducts.v2";

function loadProducts() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}

function saveProducts(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

let products = loadProducts();
// pour les anciens enregistrements sans stockage, on met par d√©faut "garage"
products = products.map(p => ({ ...p, stockage: p.stockage || "garage" }));

const rayonOrder = [
  "fruits et legumes",
  "frais",
  "surgeles",
  "sec",
  "alcool",
  "softs",
  "hygiene",
  "materiel"
];

const stockageOrder = [
  "chambre froide",
  "piece a viande",
  "produits d'entretien",
  "caveau",
  "garage"
];

const rayonIcons = {
  "fruits et legumes": "ü•ï",
  "frais": "ü•õ",
  "surgeles": "‚ùÑÔ∏è",
  "sec": "üì¶",
  "alcool": "üç∑",
  "softs": "ü•§",
  "hygiene": "üßº",
  "materiel": "üß∞"
};

function sortByRayonThenName(a, b) {
  const A = rayonOrder.indexOf(a.rayon);
  const B = rayonOrder.indexOf(b.rayon);
  const ra = A === -1 ? 999 : A;
  const rb = B === -1 ? 999 : B;
  if (ra !== rb) return ra - rb;
  return a.name.localeCompare(b.name, "fr", { sensitivity: "base" });
}

function sortByStockageThenRayonThenName(a, b) {
  const ZA = stockageOrder.indexOf(a.stockage);
  const ZB = stockageOrder.indexOf(b.stockage);
  const za = ZA === -1 ? 999 : ZA;
  const zb = ZB === -1 ? 999 : ZB;
  if (za !== zb) return za - zb;
  return sortByRayonThenName(a, b);
}

/* AFFICHAGE PRODUITS */
const productsListEl = document.getElementById("productsList");

function renderProducts() {
  productsListEl.innerHTML = "";

  if (products.length === 0) {
    productsListEl.innerHTML = "<div style='padding:10px;color:#9ca3af;'>Aucun produit enregistr√©</div>";
    return;
  }

  const sorted = [...products].sort(sortByRayonThenName);
  let currentRayon = null;

  for (const p of sorted) {
    if (p.rayon !== currentRayon) {
      currentRayon = p.rayon;
      const rt = document.createElement("div");
      rt.className = "rayon-title";
      rt.textContent = (rayonIcons[currentRayon] || "") + " " + currentRayon;
      productsListEl.appendChild(rt);
    }

    const row = document.createElement("div");
    row.className = "product-row";

    const main = document.createElement("div");
    main.className = "product-main";

    const n = document.createElement("div");
    n.className = "product-name";
    n.textContent = p.name;

    const meta = document.createElement("div");
    meta.className = "product-meta";
    meta.textContent = `Qt√©: ${p.defaultQty} ¬∑ Rayon: ${p.rayon} ¬∑ Stockage: ${p.stockage}`;

    main.appendChild(n);
    main.appendChild(meta);

    const acts = document.createElement("div");
    acts.className = "product-actions";

    const fill = document.createElement("button");
    fill.className = "btn-secondary btn-small";
    fill.textContent = "√âditer";
    fill.onclick = () => {
      prodName.value = p.name;
      prodRayon.value = p.rayon;
      prodStock.value = p.stockage || "garage";
      prodQty.value = p.defaultQty;
    };

    const del = document.createElement("button");
    del.className = "btn-danger btn-small";
    del.textContent = "Supprimer";
    del.onclick = () => {
      products = products.filter(x => x.id !== p.id);
      saveProducts(products);
      renderProducts();
    };

    acts.appendChild(fill);
    acts.appendChild(del);

    row.appendChild(main);
    row.appendChild(acts);

    productsListEl.appendChild(row);
  }
}

renderProducts();

/* AJOUT / MODIF PRODUIT */
const prodName = document.getElementById("prodName");
const prodRayon = document.getElementById("prodRayon");
const prodQty = document.getElementById("prodQty");
const prodStock = document.getElementById("prodStock");
const productForm = document.getElementById("productForm");

productForm.onsubmit = (e) => {
  e.preventDefault();

  const name = prodName.value.trim();
  if (!name) return;

  const rayon = prodRayon.value;
  const stockage = prodStock.value;
  const qty = parseInt(prodQty.value) || 1;

  let existing = products.find(
    p =>
      p.name.toLowerCase() === name.toLowerCase() &&
      p.rayon === rayon &&
      p.stockage === stockage
  );

  if (existing) {
    existing.defaultQty = qty;
  } else {
    products.push({
      id: Date.now(),
      name,
      rayon,
      stockage,
      defaultQty: qty
    });
  }

  saveProducts(products);
  renderProducts();

  prodName.value = "";
  prodQty.value = "1";
};

/* wipe all */
document.getElementById("resetProducts").onclick = () => {
  products = [];
  saveProducts(products);
  renderProducts();
};

/* MODE SWIPE */
let sessionProducts = [];
let sessionIndex = 0;
let currentList = [];
let currentQty = 1;

const swipeOverlay = document.getElementById("swipeOverlay");
const swipeRayon = document.getElementById("swipeRayon");
const swipeStock = document.getElementById("swipeStock");
const swipeName = document.getElementById("swipeName");
const swipeProgress = document.getElementById("swipeProgress");
const qtyValue = document.getElementById("qtyValue");

const startSessionBtn = document.getElementById("startSession");
const closeSwipeBtn = document.getElementById("closeSwipe");

startSessionBtn.onclick = () => {
  if (products.length === 0) {
    alert("Ajoute des produits d'abord.");
    pageHome.style.display = "none";
    pageProducts.style.display = "block";
    return;
  }

  // Tri par stockage, puis rayon, puis nom
  sessionProducts = [...products].sort(sortByStockageThenRayonThenName);
  sessionIndex = 0;
  currentList = [];
  updateSwipeCard();
  swipeOverlay.style.display = "block";
};

closeSwipeBtn.onclick = () => {
  swipeOverlay.style.display = "none";
  renderResultList();
};

function updateSwipeCard() {
  if (sessionIndex >= sessionProducts.length) {
    swipeOverlay.style.display = "none";
    renderResultList();
    return;
  }

  const p = sessionProducts[sessionIndex];
  swipeRayon.textContent = (rayonIcons[p.rayon] || "") + " " + p.rayon;
  swipeStock.textContent = p.stockage;
  swipeName.textContent = p.name;

  currentQty = p.defaultQty || 1;
  qtyValue.textContent = currentQty;

  swipeProgress.textContent = `Article ${sessionIndex + 1}/${sessionProducts.length}`;
}

const btnQtyMinus = document.getElementById("btnQtyMinus");
const btnQtyPlus = document.getElementById("btnQtyPlus");
const btnAdd = document.getElementById("btnAdd");
const btnSkip = document.getElementById("btnSkip");

btnQtyMinus.onclick = () => {
  currentQty = Math.max(1, currentQty - 1);
  qtyValue.textContent = currentQty;
};

btnQtyPlus.onclick = () => {
  currentQty = Math.min(999, currentQty + 1);
  qtyValue.textContent = currentQty;
};

btnAdd.onclick = () => {
  const p = sessionProducts[sessionIndex];
  currentList.push({
    name: p.name,
    rayon: p.rayon,
    stockage: p.stockage,
    qty: currentQty
  });
  sessionIndex++;
  updateSwipeCard();
};

btnSkip.onclick = () => {
  sessionIndex++;
  updateSwipeCard();
};

/* Swipe gestures */
let startX = null;
let startY = null;
const swipeCard = document.getElementById("swipeCard");

swipeCard.addEventListener("touchstart", (e) => {
  const t = e.changedTouches[0];
  startX = t.screenX;
  startY = t.screenY;
}, { passive: true });

swipeCard.addEventListener("touchend", (e) => {
  const t = e.changedTouches[0];
  const dx = t.screenX - startX;
  const dy = t.screenY - startY;

  if (Math.abs(dy) > Math.abs(dx)) return;

  if (dx < -60) btnAdd.onclick();
  if (dx > 60) btnSkip.onclick();
}, { passive: true });

/* R√âSULTAT + IMPRESSION */
const resultListEl = document.getElementById("resultList");
const printListContainer = document.getElementById("printListContainer");
const sessionSummary = document.getElementById("sessionSummary");

function renderResultList() {
  resultListEl.innerHTML = "";
  printListContainer.innerHTML = "";

  if (currentList.length === 0) {
    sessionSummary.style.display = "none";
    return;
  }

  const grouped = {};
  for (const it of currentList) {
    const key = it.rayon + "||" + it.name;
    if (!grouped[key]) grouped[key] = { ...it, qty: 0 };
    grouped[key].qty += it.qty;
  }

  let arr = Object.values(grouped).sort(sortByRayonThenName);
  let cur = null;

  for (const it of arr) {
    if (it.rayon !== cur) {
      cur = it.rayon;
      const h = `<div class="rayon-title">${rayonIcons[cur] || ''} ${cur}</div>`;
      resultListEl.innerHTML += h;
      printListContainer.innerHTML += h;
    }
    const row = `<div class="result-row"><div>${it.name}</div><div>${it.qty}</div></div>`;
    resultListEl.innerHTML += row;
    printListContainer.innerHTML += row;
  }

  sessionSummary.style.display = "block";
}

const printListBtn = document.getElementById("printList");
printListBtn.onclick = () => {
  window.print();
};
</script>
</body>
</html>
